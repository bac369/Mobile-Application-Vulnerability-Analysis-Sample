# AppSec 4

## Task 0: Beginning Modifications
When I tried registering or logging in, the Giftcardsite app would crash. I looked at the logs and it turned that since I denied location permissions the app would experience a FATAL_ERROR. I fixed this by removing the lines dealing with location services in ProductScrollingActivity. After which I was successfully able to register and login.

![Pic2](/Report/Artifacts/bac369-t1a.png)

---

## Task 1

### Task 1a: What's the Difference

- 1:
The two types of intenets are Implicit and Explicit. Implicit declares an action and expects another app to handle it. Explicit declares a specific target or resource to be used.
- 2:
The more secure intent is Explicit because the developer chooses exactly what needs to be done and what is going to do it. Implicit intents are more likely to be exploited due to their openness.
- 3:
The intent shown in [SecondFragment.kt](/GiftcardSite/app/src/main/java/com/example/giftcardsite/SecondFragment.kt) is an implicit intent, since it is not specifying what activity to do.
<br />

![Pic2](/Report/Artifacts/bac369-t15.png)
<br />


- 4:
The intent in [ThirdFragment.kt](/GiftcardSite/app/src/main/java/com/example/giftcardsite/ThirdFragment.kt) is Explicit, since it is specifically asking to start the ProductScrolling activity.
<br />

![Pic2](/Report/Artifacts/bac369-t16.png)

<br />

- 5:
The explicit intent in ThirdFragment.kt is more secure because it is specifically asking to start the ProductScrollingActivity and not reaching out to the API or a third party application for instructions.

### Task 1b: Switching Intents
I chose to fix the less secure, Implicit intent SecondFragment.kt  by replacing it with the Explicit intent in ThirdFragment.kt. I removed `var intent = Intent(Intent.ACTION_VIEW)
                  intent.type = "text/giftcards_browse"
                        intent.data = Uri.parse("https:[//]nyuappsec].]com/api/index")` and replaced it with `var intent = Intent(activity, ProductScrollingActivity::class.java)`
This causes both login and register actions to result in the  `ProductScrollingActivity`. Since the SecondFragment.kt now uses an Explicit Intent it is more secure. As you can see below, the logs show a successful register with the text `Register Success. Boo.` and the user was brought to the ProductScrollingActivity.
<br />
### Before:
![Pic2](/Report/Artifacts/bac369-t1c.png)
<br />
### After:
![Pic2](/Report/Artifacts/bac369-t1b.png)
<br />

### Task 1c: Shutting Out the World
The [AndroidManifest.xml](/GiftcardSite/app/src/main/AndroidManifest.xml) used intent filters to reach out to `nyuappsec[.]com`. To fix this I removed the `<intent-filter>` blocks from all activities except one, thereby removing the calls to `nyuappsec[.]com`. The only one I did not remove was to `.MainActivity.` since this is needed to start the app and also does not reach out to other applications.
![Pic2](/Report/Artifacts/bac369-t1c5.png)

---
## Task 2

Using HTTP Toolkit, I inspected the packets the app was sending. In the picture below is an example of the `http` traffic to the nyuappsec.com api. There is also a code snippet that shows an offending call using `http`.
![Pic2](/Report/Artifacts/bac369-t2a.png)
![Pic2](/Report/Artifacts/bac369-t2a12.png)
Instead of going through each file individually, I used "Replace All in files" and replaced `http://nyuappsec[.]com` with `https://nyuappsec[.]com`.
![Pic2](/Report/Artifacts/bac369-t2b.png)
I then rebuilt the app successfully and navigated around.  The app still ran properly and the packet capture from HTTP Toolkit showed the app now reaching out to `https://nyuappsec[.]com`.
![Pic2](/Report/Artifacts/bac369-t2c.png)

---

## Task 3
- #### A.
   The system in place to use a card is vulnerable. The interaction between the app and the API is exploitable allowing a user to use another card than the system intended. Looking into [UseCard.kt](/GiftcardSite/app/src/main/java/com/example/giftcardsite/UseCard.kt), I found the line `@PUT("/api/use/{card_number}") fun useCard(@Path("card_number") card_number: Int?, @Header("Authorization") authHeader: String): Call<Card?>`. This line sends a PUT request using only the `card_number` and a token to decide which card to use. However, the token is not used to verify or authorize on the backend and only the `card_number` decides which card is used.
   <br />

   ![Pic2](/Report/Artifacts/bac369-t4g.png)
   <br />
Using this knowledge and HTTP Toolkit's Mock and Intercept tools, the exploit was as simple as modifying the PUT request. I was able to intercept the PUT request sent to the server and modify it to use another card.  As you can see in the image below, the PUT request was originally for card `id 509`, but I intercepted and changed the URL so it used `id 311` instead. This is confirmed as you can see in the Response body the card `id: 311` was used instead of 509.
![Pic2](/Report/Artifacts/bac369-t4e.png)
- #### B
As the application stands, the only other value that can be used to authorize the usage of a proper, user owned card is the `authorization Token`. Currently there is no interaction between the app and the API server that uses this token to authorize card usage. The api server should have a system that uses the Token passed through the application to check that the current user and current session align with the card holder of the card attempting to be used. The API can when send a response back to the application which when interpreted by the app tells the user an error occured. Based off the Usecard.kt code it looks like the token is being passed and the response and authentication should be all done server side. The API and server code needs to be modified. Modification of the app source code does not seem necessary except for parsing the "invalid card" response or unless extra security and authorization is desired. The server is already receiving the card id and Token needed to authorize.

---
### Task 4
Note: I believe there is a good amount of overlap between parts A, B, and C, especially with the onLocationChanged and onSensorChanged functions dealing with metrics regarding Location and Sensor. I did most of the changes with a few deletes. I did my best to breakdown the changes into the section that makes the most sense.
### Code Modified:
1. [AndroidManifest.xml](/GiftcardSite/app/src/main/AndroidManifest.xml)
2. [CardScrollingActivity.kt](/GiftcardSite/app/src/main/java/com/example/giftcardsite/CardScrollingActivity.kt)
3. [ProductScrollingActivity.kt](/GiftcardSite/app/src/main/java/com/example/giftcardsite/ProductScrollingActivity.kt)
#### A.
In [AndroidManifest.xml](/GiftcardSite/app/src/main/AndroidManifest.xml) I found location permissions at the top of the file. I removed the `ACCESS_FINE_LOCATION`, which finds a user more precise location, `Access_COARSE_LCOATION`, which finds a less precise location, and `ACCESS_MOCK_LOCATION`, which uses a fake location. I removed them all I considered keeping `ACCESS_MOCK_LOCATION`, but I realized the app should not need location services at all and even leaving it for testing purposes is unneccessary. The permissions for `ACCESS_NETWORK_STATE` and `INTERNET` stayed because they are necessary for the app to interact with the API.

---
Before removal:
![Pic2](/Report/Artifacts/bac369-t5a12.png)
After removal:
![Pic2](/Report/Artifacts/bac369-t5a2.png)
---
I also commented out or removed the location permissions and calls to and refering to `LOCATION_SERVICE` and the `LocationListener` in [ProductScrollingActivity.kt](/GiftcardSite/app/src/main/java/com/example/giftcardsite/ProductScrollingActivity.kt) and [CardScrollingActivity.kt](/GiftcardSite/app/src/main/java/com/example/giftcardsite/CardScrollingActivity.kt).
![Pic2](/Report/Artifacts/bac369-t5a3.png)

---
#### B.
I used HTTP Toolkit to look for the app sending metrics. I saw that both the ProductScrollingActivity and CardScrollingActivity sent out metrics. Below shows the constant posts to `nyuappsec[.]com/api/metrics` while on the CardScrollingActivity.
![Pic2](/Report/Artifacts/bac369-t5b2.png)
I found the offending code was the snippet below.
![Pic2](/Report/Artifacts/bac369-t5b3.png)
This chunk of code creates a [UserInfo.kt](/GiftcardSite/app/src/main/java/com/example/giftcardsite/api/service/UserInfo.kt) class based off location and sends the users location to the api/metrics. It no longer fucntioned because of the changes in Part A which removed the apps permissions to collect location and the calls to access the Lcoation service. I removed it and rebuilt the app, but I was getting errors regarding the sensor so before testing again I moved on to part C.

<br />

Note: I looked over [UserInfo.kt](/GiftcardSite/app/src/main/java/com/example/giftcardsite/api/service/UserInfo.kt) which sends "api/metric" to the api. I removed all the functions referencing it in the [CardScrollingActivity.kt](/GiftcardSite/app/src/main/java/com/example/giftcardsite/CardScrollingActivity.kt) and
[ProductScrollingActivity.kt](/GiftcardSite/app/src/main/java/com/example/giftcardsite/ProductScrollingActivity.kt), so it was not necessary to remove the file. It functionally no longer has a purpose and does not send metrics to the api.

#### C.

Like with the location removals, I removed all references to Sensors, the SensorManager, and SensorEventListener. Thereby removing the application's ability to use the device's Sensor for the respective activities.

<br />

Before removal:
![Pic2](/Report/Artifacts/bac369-5c2.png)
After removal:
![Pic2](/Report/Artifacts/bac369-5c3.png)
---
I also removed the chunks of code `onSensorChanged`, `onAccuracyChanged` and `onResume`. This chunk of code creates a UserInfo metric based off sensor data and sends the users sensor data to the api/metrics. It no longer functioned because of the changes made above which removed the listerner and access to the device's Sensor service.
![Pic2](/Report/Artifacts/bac369-t5c4.png)

----
### Putting it all together
Once I removed the all the code outlined in the parts above, I rebuilt the application without errors and again ran it through HTTP Toolkit. As you can see below I tested the application running through the login, buy, and use card activities, and no metrics were sent out.
![Pic2](/Report/Artifacts/bac369-5w.png)
